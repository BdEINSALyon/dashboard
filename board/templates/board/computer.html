{% extends 'board/base.html' %}
{% load tz %}
{% load static %}
{% block meta %}
    <meta http-equiv="refresh" content="60;">
{% endblock meta %}

{% block body-js %}
    {{ block.super }}
    <script src="{% static 'board/script.js' %}"></script>
{% endblock body-js %}

{% block content %}
    <div class="row">
        <div class="col-md-12">
        <div class="d-flex justify-content-between my-3">
            <div class="h1 d-inline m-0">
                {% block title %}Salle IF{% endblock title %}
            </div>
            <div class="hidden-sm-down btn-group align-self-center">
                <button class="hide-ok switch btn btn-secondary">Montrer uniquement les problèmes.</button>
                <button class="show-ok switch btn btn-secondary">Montrer tous les postes.</button>
            </div>
        </div>
        </div>
    </div>
    <div class="row hidden-md-up mb-3">
        <div class="col-sm-12">
            <button class="hide-ok switch btn-block btn btn-secondary">Montrer uniquement les problèmes.</button>
            <button class="show-ok switch btn-block btn btn-secondary">Montrer tous les postes.</button>
        </div>
    </div>
    <div class="row">
        {% for computer in computer_list %}
            {% with status=computer.status %}
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="mb-3 card card-outline-{{ computer.get_color }}">
                        <h6 class="card-header card-inverse bg-{{ computer.get_color }}">
                            {{ computer.name }}
                            {% if status.description %}
                                <small>{{ status.description }}</small>
                            {% endif %}
                        </h6>
                        <div class="card-block">
                            <ul class="list-unstyled mb-0">
                                <li class="text-white bg-{% if status.imprimante_ma %}success{% else %}danger{% endif %}">
                                    Imprimante MA
                                </li>
                                <li class="text-white bg-{% if status.windows_activation %}success{% else %}danger{% endif %}">
                                    Activation de Windows
                                </li>
                                <li>Tâches programmées :
                                    <ul class="no-style">
                                        {% for _, task in computer.get_sorted_tasks %}
                                            <li data-toggle="tooltip"
                                                data-placement="top"
                                                title="{% if task.verification and task.verification.type == 'task' %}Tâche(s) : {{ task.verification.task_names|join:', ' }}{% endif %}"
                                                class="text-white bg-{% if task.installed %}success{% elif task.mandatory %}danger{% else %}warning{% endif %}">
                                                {{ task.name }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                                <li>Logiciels :
                                    <ul class="no-style">
                                        {% for _, app in computer.get_sorted_apps %}
                                            <li data-toggle="tooltip"
                                                data-placement="top"
                                                title="{% if app.verification and app.verification.type == 'path' %}Chemin(s) : {{ app.verification.paths|join:', ' }}{% endif %}"
                                                class="text-white bg-{% if app.installed %}success{% elif app.mandatory %}danger{% else %}warning{% endif %}">
                                                {{ app.name }}
                                            </li>
                                        {% endfor %}
                                    </ul>
                                </li>
                                {% if status.network %}
                                    <li>Réseau :
                                        <ul class="no-style">
                                            <li>Adresse IP : {{ status.network.ip }}</li>
                                            <li class="text-white bg-{% if status.network.dhcp %}success{% else %}danger{% endif %}">
                                                DHCP activé
                                            </li>
                                        </ul>
                                    </li>
                                {% endif %}
                                <li>RAM ({{ computer.total_ram }} Go)
                                    <div class="progress">
                                        <div class="progress-bar bg-{{ computer.get_ram_color }}"
                                             role="progressbar" aria-valuenow="{{ computer.get_ram_percentage }}"
                                             aria-valuemin="0" aria-valuemax="100"
                                             style="width: {{ computer.get_ram_percentage }}%;">
                                            {{ computer.get_ram_percentage }}%
                                        </div>
                                    </div>
                                </li>
                                <li>Disque dur C: ({{ computer.total_disk }} Go)
                                    <div class="progress">
                                        <div class="progress-bar bg-{{ computer.get_disk_color }}"
                                             role="progressbar" aria-valuenow="{{ computer.get_disk_percentage }}"
                                             aria-valuemin="0" aria-valuemax="100"
                                             style="width: {{ computer.get_disk_percentage }}%;">
                                            {{ computer.get_disk_percentage }}%
                                        </div>
                                    </div>
                                </li>

                                {% with prof=status.os.temp_profiles %}
                                    <li class="{% if status.os.temp_profiles is not None %}text-white bg-{{ computer.get_temp_color }}{% endif %}">
                                        <span class="badge badge-pill badge-default">{{ prof }}</span>
                                        profil{% if prof > 1 %}s{% endif %}
                                        temporaire{% if prof|length > 1 %}s{% endif %}
                                    </li>
                                {% endwith %}

                                <li class="text-white bg-{% if computer.is_offline %}warning{% else %}success{% endif %}">
                                    Dernier reporting
                                    {{ computer.last_update|date:"SHORT_DATETIME_FORMAT" }}
                                </li>

                                {% with locked=status.os.locked %}
                                    <li>
                                        {% if locked %}
                                            <a data-toggle="collapse" href="#session-{{ computer.name }}">
                                        {% endif %}
                                            <span class="badge badge-pill badge-default">{{ locked|length }}</span>
                                            session{% if locked|length > 1 %}s{% endif %}
                                            verrouillée{% if locked|length > 1 %}s{% endif %}
                                        {% if locked %}
                                            </a>
                                        {% endif %}
                                        <div id="session-{{ computer.name }}" class="collapse">
                                            <ul>
                                                {% for username in status.os.locked %}
                                                    <li>
                                                        {{ username }}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </li>
                                {% endwith %}
                            </ul>
                        </div>
                    </div>
                </div>
            {% endwith %}
        {% endfor %}
        </div>
{% endblock content %}
